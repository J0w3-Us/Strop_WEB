---
// Este componente SÃ se ejecuta en el cliente (navegador)
import { login } from "../service/auth.service";
---

<form id="login-form">
  <div class="form-group">
    <label for="email">Correo ElectrÃ³nico</label>
    <input
      type="email"
      id="email"
      name="email"
      placeholder="email@strop.com"
      required
    />
  </div>

  <div class="form-group" style="position:relative">
    <label for="password">ContraseÃ±a</label>
    <input type="password" id="password" name="password" required />
    <button
      type="button"
      id="toggle-show"
      style="position:absolute;right:10px;top:36px;border:0;background:transparent"
      >ğŸ‘ï¸</button
    >
  </div>

  <div class="helper-row">
    <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem"
      ><input type="checkbox" id="remember" /> Recordarme</label
    >
    <a href="#" style="color:#0b69a3;font-size:0.9rem;text-decoration:none"
      >Â¿Olvidaste tu contraseÃ±a?</a
    >
  </div>

  <p id="error-message" class="error"></p>

  <button type="submit" class="btn-primary">Iniciar SesiÃ³n</button>

  <div
    style="display:flex;align-items:center;gap:12px;margin:18px 0;align-items:center"
  >
    <hr style="flex:1;border:none;border-top:1px solid #e6eef6" />
    <small style="color:#94a3b8">O continuar con:</small>
    <hr style="flex:1;border:none;border-top:1px solid #e6eef6" />
  </div>

  <button type="button" class="btn-google" id="btn-google">
    <span style="width:18px;height:18px;display:inline-block">G</span>
    <span>Iniciar SesiÃ³n con Google</span>
  </button>

  <p style="text-align:center;margin-top:14px;font-size:0.9rem;color:#64748b">
    Â¿No tienes una cuenta? <a href="/register" style="color:#fb923c"
      >RegÃ­strate aquÃ­</a
    >
  </p>
</form>

<script>
  // FunciÃ³n de login simplificada
  async function performLogin(
    email: string,
    password: string
  ): Promise<string> {
    // SimulaciÃ³n
    await new Promise((resolve) => setTimeout(resolve, 800));

    if (!email || !password) {
      throw new Error("Por favor ingresa email y contraseÃ±a");
    }

    // Crear usuario simulado
    const user = {
      id: 1,
      name: email.split("@")[0] || "Usuario",
      email: email,
      role: "admin",
      phone: "000-000-0000",
      is_active: true,
    };

    // Guardamos datos en localStorage
    localStorage.setItem("authToken", "fake-jwt-token-" + Date.now());
    localStorage.setItem("user", JSON.stringify(user));

    return "/dashbord";
  }

  // Inicializar cuando el DOM estÃ© listo
  function initLoginForm() {
    const form = document.getElementById("login-form") as HTMLFormElement;
    const errorEl = document.getElementById("error-message") as HTMLElement;

    if (!form || !errorEl) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      const formData = new FormData(form);
      const email = formData.get("email") as string;
      const password = formData.get("password") as string;
      const submitBtn = form.querySelector(
        'button[type="submit"]'
      ) as HTMLButtonElement;

      if (!email || !password) {
        errorEl.textContent = "Por favor completa todos los campos";
        return;
      }

      // UI de carga
      errorEl.textContent = "";
      submitBtn.disabled = true;
      submitBtn.textContent = "Iniciando...";

      try {
        const redirectUrl = await performLogin(email, password);
        console.log("Login exitoso, redirigiendo a:", redirectUrl);

        // Usar replace para evitar problemas de navegaciÃ³n
        window.location.replace(redirectUrl);
      } catch (err) {
        console.error("Error de login:", err);
        errorEl.textContent = (err as Error).message;
        submitBtn.disabled = false;
        submitBtn.textContent = "Iniciar SesiÃ³n";
      }
    });

    // Toggle password visibility
    const toggle = document.getElementById("toggle-show");
    toggle?.addEventListener("click", (e) => {
      e.preventDefault();
      const pwd = document.getElementById("password") as HTMLInputElement;
      if (!pwd) return;
      pwd.type = pwd.type === "password" ? "text" : "password";
    });

    // Google button
    document.getElementById("btn-google")?.addEventListener("click", (e) => {
      e.preventDefault();
      alert("Funcionalidad de Google en desarrollo");
    });
  }

  // Ejecutar cuando el documento estÃ© listo
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initLoginForm);
  } else {
    initLoginForm();
  }
</script>

<style>
  /* AquÃ­ van los estilos para tu formulario */
  .error {
    color: red;
  }
</style>
