---
import Layout from "../../layouts/Layout.astro";
import Topbar from "../../components/dashbord/Topbar.astro";
import Sidebar from "../../components/dashbord/Sidebar.astro";
import "../../styles/dashbord.css";
import { getAllIncidents } from "../../service/incident.service";

// Cargar datos mock desde el servicio (alineados con IncidentModel móvil)
const incidencias = (await getAllIncidents()) as any[];

const filtros = {
  tipos: [
    { key: "all", label: "Todos" },
    { key: "safetyIncident", label: "Seguridad" },
    { key: "materialRequest", label: "Materiales" },
    { key: "progressReport", label: "Avance" },
    { key: "problem", label: "Problemas" },
    { key: "consultation", label: "Consultas" },
  ],
};
---

<Layout title="Gestor de Incidencias - Strop">
  <div class="dashboard-layout">
    <Sidebar />

    <div class="main-content">
      <Topbar />

      <div class="content-area">
        <div class="incidencias-container">
          <!-- Header -->
          <div class="incidencias-header">
            <h1 class="page-title">Gestor de Incidencias</h1>

            <!-- Search Bar -->
            <div class="search-container">
              <div class="search-box">
                <svg
                  class="search-icon"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input
                  type="text"
                  placeholder="Buscar por título, ID o palabra clave..."
                  class="search-input"
                />
              </div>
            </div>
          </div>

          <!-- Filters and Tabs -->
          <div class="filters-section">
            <div class="filters-left">
              <!-- Type Filter -->
              <div class="filter-group">
                <select id="typeFilter" class="filter-select">
                  {
                    filtros.tipos.map((t) => (
                      <option value={t.key}>{t.label}</option>
                    ))
                  }
                </select>
              </div>

              <!-- Status Filter -->
              <!-- <div class="filter-group">
                <select class="filter-select">
                  <option>Ver Todo</option>
                   {
                    filtros.estados
                      .slice(1)
                      .map((estado) => <option>{estado}</option>)
                  } 
                </select>
              </div> -->
            </div>

            <!-- Status Tabs -->
            <!-- <div class="status-tabs">
              {
                estadosTab.map((estado, index) => (
                  <button
                    class={`status-tab ${index === 0 ? "active" : ""}`}
                    data-status={estado.toLowerCase()}
                  >
                    {estado}
                  </button>
                ))
              }
            </div> -->
          </div>

          <!-- Incidents Table (Tabla de Control de Obra) -->
          <div class="incidents-table-container">
            <table class="incidents-table">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Detalle</th>
                  <th>Autor</th>
                  <th>Prioridad</th>
                  <th>Material / Detalle</th>
                  <th>Aprobación</th>
                  <th>Estado</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody id="incidentsBody">
                {
                  incidencias.map((incidencia) => (
                    <tr
                      class={`incident-row ${incidencia.isCritical ? "critical" : ""}`}
                      data-id={incidencia.id}
                      data-type={incidencia.type}
                      data-approval={incidencia.approvalStatus}
                    >
                      <td>
                        <div
                          title={incidencia.type}
                          class={`w-8 h-8 rounded-lg flex items-center justify-center ${
                            incidencia.type === "safetyIncident"
                              ? "bg-type-safety/10"
                              : incidencia.type === "materialRequest"
                                ? "bg-type-material/10"
                                : incidencia.type === "progressReport"
                                  ? "bg-type-progress/10"
                                  : incidencia.type === "problem"
                                    ? "bg-type-problem/10"
                                    : "bg-type-consultation/10"
                          }`}
                        >
                          {incidencia.type === "safetyIncident" && (
                            <svg
                              class="w-5 h-5"
                              style="color: var(--type-safety)"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
                            </svg>
                          )}
                          {incidencia.type === "materialRequest" && (
                            <svg
                              class="w-5 h-5"
                              style="color: var(--type-material)"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2v14H3v3c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V2l-1.5 1.5zM19 19c0 .55-.45 1-1 1s-1-.45-1-1v-3H8V5h11v14z" />
                              <path d="M9 7h6v2H9zm7 0h2v2h-2zm-7 3h6v2H9zm7 0h2v2h-2z" />
                            </svg>
                          )}
                          {incidencia.type === "progressReport" && (
                            <svg
                              class="w-5 h-5"
                              style="color: var(--type-progress)"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                            </svg>
                          )}
                          {incidencia.type === "problem" && (
                            <svg
                              class="w-5 h-5"
                              style="color: var(--type-problem)"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                            </svg>
                          )}
                          {incidencia.type === "consultation" && (
                            <svg
                              class="w-5 h-5"
                              style="color: var(--type-consultation)"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z" />
                            </svg>
                          )}
                        </div>
                      </td>

                      <td>
                        <div class="font-bold">{incidencia.title}</div>
                        {incidencia.type === "materialRequest" &&
                          incidencia.materialDetails && (
                            <div class="badge-material mt-1">
                              <strong>Cantidad:</strong>{" "}
                              {incidencia.materialDetails.quantity}{" "}
                              {incidencia.materialDetails.unit}
                              <br />
                              <span class="text-xs">
                                {incidencia.materialDetails.itemName}
                              </span>
                            </div>
                          )}
                      </td>

                      <td>
                        <div>{incidencia.authorName}</div>
                        <span
                          class={`text-xs uppercase font-semibold ${
                            incidencia.authorRole === "superintendent"
                              ? "text-role-superintendent"
                              : incidencia.authorRole === "resident"
                                ? "text-role-resident"
                                : incidencia.authorRole === "cabo"
                                  ? "text-role-cabo"
                                  : "text-gray-500"
                          }`}
                        >
                          {incidencia.authorRole}
                        </span>
                      </td>

                      <td class="col-priority">
                        <span
                          class={`priority-badge ${incidencia.isCritical ? "priority-high" : "priority-normal"}`}
                        >
                          {incidencia.isCritical ? "Alta" : "Normal"}
                        </span>
                      </td>

                      <td class="col-material">
                        {incidencia.type === "materialRequest" &&
                        incidencia.materialDetails ? (
                          <span class="material-badge">
                            <strong>
                              {incidencia.materialDetails.quantity}
                            </strong>{" "}
                            {incidencia.materialDetails.unit}
                          </span>
                        ) : (
                          <span class="no-material">—</span>
                        )}
                      </td>

                      <td>
                        {incidencia.type === "materialRequest" &&
                        incidencia.approvalStatus === "pending" ? (
                          <div class="flex gap-2">
                            <button
                              class="px-3 py-1 rounded text-sm font-medium bg-status-approved/10 text-status-approved hover:bg-status-approved/20 transition-colors flex items-center gap-1"
                              onclick={`approve('${incidencia.id}')`}
                            >
                              <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                              </svg>
                              Autorizar
                            </button>
                            <button
                              class="px-3 py-1 rounded text-sm font-medium bg-status-rejected/10 text-status-rejected hover:bg-status-rejected/20 transition-colors flex items-center gap-1"
                              onclick={`reject('${incidencia.id}')`}
                            >
                              <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                              </svg>
                              Rechazar
                            </button>
                          </div>
                        ) : incidencia.approvalStatus ? (
                          <span
                            class={`px-3 py-1 rounded text-sm font-semibold ${
                              incidencia.approvalStatus === "approved"
                                ? "bg-status-approved/10 text-status-approved"
                                : incidencia.approvalStatus === "rejected"
                                  ? "bg-status-rejected/10 text-status-rejected"
                                  : incidencia.approvalStatus === "pending"
                                    ? "bg-status-pending/10 text-status-pending"
                                    : "bg-gray-100 text-gray-600"
                            }`}
                          >
                            {incidencia.approvalStatus}
                          </span>
                        ) : (
                          <span class="text-gray-400">—</span>
                        )}
                      </td>

                      <td class="col-status">{incidencia.status}</td>

                      <td class="col-date">
                        {new Date(incidencia.createdAt).toLocaleString()}
                      </td>
                    </tr>
                  ))
                }
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <div class="pagination-container">
            <div class="pagination-info">
              <span>Mostrando <strong>1-4</strong> de <strong>100</strong></span
              >
            </div>

            <div class="pagination-controls">
              <button class="pagination-btn" disabled>Anterior</button>
              <button class="pagination-number active">1</button>
              <button class="pagination-number">2</button>
              <button class="pagination-number">3</button>
              <button class="pagination-btn">Siguiente</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Active nav
      const currentPath = window.location.pathname;
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.classList.remove("active");
        const href = item.getAttribute("href");
        if (href === currentPath) item.classList.add("active");
      });

      const typeFilter = document.getElementById("typeFilter");
      const searchInput = document.querySelector(".search-input");
      const incidentsBody = document.getElementById("incidentsBody");

      function getRows() {
        return Array.from(
          document.querySelectorAll(".incident-row")
        ) as HTMLElement[];
      }

      function applyFilters() {
        const typeVal =
          (typeFilter && (typeFilter as HTMLSelectElement).value) || "all";
        const searchTerm =
          (searchInput &&
            (searchInput as HTMLInputElement).value.toLowerCase()) ||
          "";

        getRows().forEach((row) => {
          const rowType = row.dataset.type || "";
          const titleEl = row.querySelector(".incident-title");
          const descEl = row.querySelector(".incident-description");
          const title = (titleEl?.textContent || "").toLowerCase();
          const desc = (descEl?.textContent || "").toLowerCase();

          const matchesType = typeVal === "all" || rowType === typeVal;
          const matchesSearch =
            !searchTerm ||
            title.includes(searchTerm) ||
            desc.includes(searchTerm) ||
            (row.dataset.id || "").includes(searchTerm);

          row.style.display = matchesType && matchesSearch ? "" : "none";
        });
      }

      if (typeFilter) {
        typeFilter.addEventListener("change", () => applyFilters());
      }

      if (searchInput) {
        searchInput.addEventListener("input", () => applyFilters());
      }

      // persistence for approvals
      const STORAGE_APPROVALS = "strop_incident_approvals";
      const storedApprovals = JSON.parse(
        localStorage.getItem(STORAGE_APPROVALS) || "{}"
      );
      function saveApprovals() {
        localStorage.setItem(
          STORAGE_APPROVALS,
          JSON.stringify(storedApprovals)
        );
      }

      // Apply stored approvals to existing rows
      Array.from(document.querySelectorAll(".incident-row")).forEach((r) => {
        const row = r as HTMLElement;
        const id = row.dataset.id;
        if (id && storedApprovals[id]) {
          const cell = row.querySelector(".col-approval");
          if (cell)
            cell.innerHTML = `<span class="approval-status ${storedApprovals[id]}">${storedApprovals[id]}</span>`;
          row.dataset.approval = storedApprovals[id];
        }
      });

      // Approval actions (delegation) with persistence
      document.addEventListener("click", function (e) {
        const target = e.target as HTMLElement;
        const approveBtn = target.closest(".btn-approve") as HTMLElement | null;
        const rejectBtn = target.closest(".btn-reject") as HTMLElement | null;

        if (approveBtn || rejectBtn) {
          const id = (approveBtn || rejectBtn)?.dataset.id;
          if (!id) return;
          const row = document.querySelector(
            `.incident-row[data-id="${id}"]`
          ) as HTMLElement | null;
          if (!row) return;

          const approvalCell = row.querySelector(
            ".col-approval"
          ) as HTMLElement | null;
          if (!approvalCell) return;

          if (approveBtn) {
            // Visual update
            approvalCell.innerHTML = `<span class="approval-status approved">approved</span>`;
            row.dataset.approval = "approved";
            storedApprovals[id] = "approved";
          } else if (rejectBtn) {
            approvalCell.innerHTML = `<span class="approval-status rejected">rejected</span>`;
            row.dataset.approval = "rejected";
            storedApprovals[id] = "rejected";
          }
          saveApprovals();
        }
      });
    });
  </script>
</Layout>
