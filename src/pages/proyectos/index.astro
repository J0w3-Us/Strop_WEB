---
import DashboardLayout from "../../layouts/Layout.astro";
import Topbar from "../../components/dashbord/Topbar.astro";
import Sidebar from "../../components/dashbord/Sidebar.astro";
import ModalCrearProyecto from "../../components/dashbord/ModalCrearProyecto.astro";
import "../../styles/dashbord.css";

// Datos de ejemplo de proyectos alineados con API móvil
const proyectos = [
  {
    id: "1",
    name: "Residencial Las Acacias",
    clientName: "Constructora Boreal",
    address: "C. de la Princesa, 31",
    location: "Madrid",
    status: "active",
    progress: 0.75,
    openIncidents: 5,
    pendingApprovals: 2,
    teamCount: 8,
    alerts: "critical",
    kpis: ["On Track", "Critical", "Pending"],
  },
  {
    id: "2",
    name: "Oficinas Centrales TechCorp",
    clientName: "Inversiones Capital",
    address: "Av. Diagonal, 400",
    location: "Barcelona",
    status: "active",
    progress: 0.4,
    openIncidents: 2,
    pendingApprovals: 0,
    teamCount: 5,
    alerts: "none",
    kpis: ["On Track"],
  },
  {
    id: "3",
    name: "Centro Comercial Norte",
    clientName: "Retail Group Holdings",
    address: "Plaça de l'Ajuntament, 1",
    location: "Valencia",
    status: "active",
    progress: 0.95,
    openIncidents: 1,
    pendingApprovals: 1,
    teamCount: 12,
    alerts: "delayed",
    kpis: ["Delayed", "Approved"],
  },
];
---

<DashboardLayout title="Gestor de Proyectos - Strop Enterprise">
  <div class="dashboard-layout bg-white min-h-screen font-sans text-slate-800">
    <Sidebar />

    <div class="main-content">
      <Topbar />

      <div class="content-area max-w-full mx-auto px-8 py-6">
        <!-- Header -->
        <div
          class="flex justify-between items-center mb-6 border-b border-slate-200 pb-6"
        >
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Proyectos</h1>
            <p class="text-sm text-slate-500 mt-1">
              Control y seguimiento de proyectos en construcción.
            </p>
          </div>
          <button
            id="btnCrearProyecto"
            class="flex items-center gap-2 px-4 py-2 bg-blue-700 hover:bg-blue-800 text-white rounded text-sm font-medium shadow-sm transition-colors"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 4v16m8-8H4"></path></svg
            >
            Crear Proyecto
          </button>
        </div>

        <!-- Projects Table -->
        <div
          class="border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm"
        >
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-slate-100 border-b border-slate-200">
                <th
                  class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                  >Proyecto</th
                >
                <th
                  class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                  >Ubicación</th
                >
                <th
                  class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider"
                  >Progreso</th
                >
                <th
                  class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right"
                  >Alertas / KPIs</th
                >
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              {
                proyectos.map((proyecto) => (
                  <tr
                    class="hover:bg-slate-50 transition-colors cursor-pointer"
                    data-project-id={proyecto.id}
                  >
                    {/* PROJECT COLUMN */}
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-4">
                        <div
                          class={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0
                        ${proyecto.status === "active" ? "bg-blue-50 text-blue-600" : "bg-slate-100 text-slate-600"}
                      `}
                        >
                          <svg
                            class="w-5 h-5"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="1.5"
                              d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"
                            />
                          </svg>
                        </div>
                        <div>
                          <h3 class="font-semibold text-slate-900 text-sm">
                            {proyecto.name}
                          </h3>
                          <p class="text-xs text-slate-500 mt-0.5">
                            {proyecto.clientName}
                          </p>
                        </div>
                      </div>
                    </td>

                    {/* LOCATION COLUMN */}
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-2 text-sm text-slate-600">
                        <svg
                          class="w-4 h-4 text-slate-400 flex-shrink-0"
                          fill="none"
                          viewBox="0 0 24 24"
                          stroke="currentColor"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                        </svg>
                        <div>
                          <div class="font-medium text-slate-700">
                            {proyecto.location}
                          </div>
                          <div class="text-xs text-slate-400 mt-0.5">
                            {proyecto.address}
                          </div>
                        </div>
                      </div>
                    </td>

                    {/* PROGRESS COLUMN */}
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="w-20">
                          <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-semibold text-slate-700">
                              {(proyecto.progress * 100).toFixed(0)}%
                            </span>
                          </div>
                          <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                            <div
                              class="h-full bg-blue-600 rounded-full transition-all"
                              style={`width: ${proyecto.progress * 100}%`}
                            />
                          </div>
                        </div>
                      </div>
                    </td>

                    {/* ALERTS / KPIS COLUMN */}
                    <td class="px-6 py-4 text-right">
                      <div class="flex justify-end gap-2 flex-wrap">
                        {proyecto.kpis.map((kpi) => (
                          <span
                            class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium
                          ${kpi === "On Track" ? "bg-emerald-50 text-emerald-700 border border-emerald-200" : ""}
                          ${kpi === "Critical" ? "bg-red-50 text-red-700 border border-red-200" : ""}
                          ${kpi === "Pending" ? "bg-amber-50 text-amber-700 border border-amber-200" : ""}
                          ${kpi === "Delayed" ? "bg-yellow-50 text-yellow-700 border border-yellow-200" : ""}
                          ${kpi === "Approved" ? "bg-blue-50 text-blue-700 border border-blue-200" : ""}
                        `}
                          >
                            {kpi}
                          </span>
                        ))}
                      </div>
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Set active navigation
      const currentPath = window.location.pathname;
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.classList.remove("active");
        const href = item.getAttribute("href");
        if (href === currentPath) item.classList.add("active");
      });

      // Project row click: redirect to project detail page
      const projectRows = document.querySelectorAll("tr[data-project-id]");
      projectRows.forEach((row) => {
        row.addEventListener("click", function (this: HTMLElement) {
          const projectId = this.dataset.projectId || "";
          window.location.href = `/proyectos/${projectId}`;
        });
      });

      // Crear Proyecto button
      const btnCrearProyecto = document.getElementById("btnCrearProyecto");
      if (btnCrearProyecto) {
        btnCrearProyecto.addEventListener("click", () => {
          if (typeof window.openModalProyecto === "function") {
            window.openModalProyecto("modalCrearProyecto");
          }
        });
      }
    });
  </script>

  <ModalCrearProyecto />
</DashboardLayout>
