---
import Layout from "../../layouts/Layout.astro";
import Topbar from "../../components/dashbord/Topbar.astro";
import Sidebar from "../../components/dashbord/Sidebar.astro";
import ModalCrearProyecto from "../../components/dashbord/ModalCrearProyecto.astro";
import "../../styles/dashbord.css";

// Datos de ejemplo de proyectos alineados con API m칩vil
const proyectos = [
  {
    id: "1",
    name: "Residencial del Valle",
    clientName: "Inmobiliaria Sur",
    address: "Av. Siempre Viva 123",
    location: "Madrid",
    status: "active",
    progress: 0.75,
    openIncidents: 5,
    pendingApprovals: 2,
    teamCount: 8,
    icono: "building",
    color: "#0A58A3",
  },
  {
    id: "2",
    name: "Centro Comercial Norte",
    clientName: "Comercial SRL",
    address: "Calle Falsa 456",
    location: "Barcelona",
    status: "completed",
    progress: 1.0,
    openIncidents: 0,
    pendingApprovals: 0,
    teamCount: 5,
    icono: "office",
    color: "#10b981",
  },
  {
    id: "3",
    name: "Viaducto Metropolitano",
    clientName: "Infraestructuras SA",
    address: "Ruta Nacional km 12",
    location: "Valencia",
    status: "paused",
    progress: 0.2,
    openIncidents: 1,
    pendingApprovals: 0,
    teamCount: 12,
    icono: "bridge",
    color: "#f59e0b",
  },
];

// Funci칩n para obtener el icono SVG seg칰n el tipo
function getProjectIcon(iconType: string): string {
  const icons: { [key: string]: string } = {
    building: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM12 7c1.11 0 2 .89 2 2 0 .72-.38 1.39-1 1.73v1.77c0 .55-.45 1-1 1s-1-.45-1-1v-1.77c-.62-.34-1-1.01-1-1.73 0-1.11.89-2 2-2z"/>
    </svg>`,
    office: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
      <path d="M19 4H5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zM9 17H7v-2h2v2zm0-4H7v-2h2v2zm0-4H7V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
    </svg>`,
    bridge: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
      <path d="M7 16c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm6 0c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm-3.5-8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S11.83 9 11 9s-1.5-.67-1.5-1.5zM22 21H2v-2h2V9.5C4 8.67 4.67 8 5.5 8h13c.83 0 1.5.67 1.5 1.5V19h2v2zM6 19h2v-7H6v7zm5 0h2v-7h-2v7zm5 0h2v-7h-2v7z"/>
    </svg>`,
  };

  return icons[iconType] || icons.building;
}

function statusLabel(status: string) {
  switch (status) {
    case "active":
      return "En Progreso";
    case "paused":
      return "Pausado";
    case "completed":
      return "Completado";
    case "cancelled":
      return "Cancelado";
    default:
      return status;
  }
}
---

<Layout title="Gestor de Proyectos - Strop">
  <div class="dashboard-layout">
    <Sidebar />

    <div class="main-content">
      <Topbar />

      <div class="content-area">
        <div class="proyectos-container">
          <!-- Header -->
          <div class="proyectos-header">
            <div class="header-left">
              <h1 class="page-title">Gestor de Proyectos</h1>
            </div>

            <div class="header-right">
              <button class="btn-create-project" id="btnCrearProyecto">
                <svg
                  width="18"
                  height="18"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"
                  ></path>
                </svg>
                Crear Proyecto
              </button>
            </div>
          </div>

          <div class="projects-container" id="projectsContainer">
            <div class="projects-grid" id="gridView">
              {
                proyectos.map((proyecto) => (
                  <div class="project-card" data-project-id={proyecto.id}>
                    <div class="card-header">
                      <div
                        class="project-icon"
                        style={`background-color: ${proyecto.color}20; color: ${proyecto.color};`}
                      >
                        <Fragment set:html={getProjectIcon(proyecto.icono)} />
                      </div>

                      <div class="project-status">
                        <span class={`status-badge ${proyecto.status}`}>
                          {statusLabel(proyecto.status)}
                        </span>
                      </div>
                    </div>

                    <div class="card-content">
                      <h3 class="project-title">{proyecto.name}</h3>
                      <p class="project-client">{proyecto.clientName}</p>

                      <div class="progress-section">
                        <div class="progress-header">
                          <span class="progress-label">
                            Progreso {(proyecto.progress * 100).toFixed(0)}%
                          </span>
                          <span class="incidents-count">
                            {proyecto.openIncidents} Incidencias
                          </span>
                        </div>
                        <div class="progress-bar">
                          <div
                            class="progress-fill"
                            style={`width: ${proyecto.progress * 100}%; background-color: ${proyecto.color};`}
                          />
                        </div>
                      </div>
                    </div>

                    <div class="card-footer">
                      <div class="team-summary">
                        游논 {proyecto.teamCount} Miembros
                      </div>
                    </div>
                  </div>
                ))
              }
            </div>

            <div class="projects-list hidden" id="listView">
              <div class="list-header">
                <div class="col-proyecto">Proyecto</div>
                <div class="col-progreso">Progreso</div>
                <div class="col-estado">Estado</div>
                <div class="col-equipo">Equipo</div>
              </div>

              {
                proyectos.map((proyecto) => (
                  <div class="project-row" data-project-id={proyecto.id}>
                    <div class="col-proyecto">
                      <div class="project-info">
                        <div
                          class="project-icon-small"
                          style={`background-color: ${proyecto.color}20; color: ${proyecto.color};`}
                        >
                          <Fragment set:html={getProjectIcon(proyecto.icono)} />
                        </div>
                        <div class="project-details">
                          <h4 class="project-name">{proyecto.name}</h4>
                          <p class="project-client">{proyecto.clientName}</p>
                        </div>
                      </div>
                    </div>

                    <div class="col-progreso">
                      <div class="progress-wrapper">
                        <span class="progress-percentage">
                          {(proyecto.progress * 100).toFixed(0)}%
                        </span>
                        <div class="progress-bar-small">
                          <div
                            class="progress-fill-small"
                            style={`width: ${proyecto.progress * 100}%; background-color: ${proyecto.color};`}
                          />
                        </div>
                        <span class="incidents-text">
                          {proyecto.openIncidents} Incidencias
                        </span>
                      </div>
                    </div>

                    <div class="col-estado">
                      <span class={`status-badge ${proyecto.status}`}>
                        {statusLabel(proyecto.status)}
                      </span>
                    </div>

                    <div class="col-equipo">
                      <div class="team-list">
                        游논 {proyecto.teamCount} Miembros
                      </div>
                    </div>
                  </div>
                ))
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // View Toggle Functionality
    document.addEventListener("DOMContentLoaded", function () {
      // Set active navigation
      const currentPath = window.location.pathname;
      const navItems = document.querySelectorAll(".nav-item");

      navItems.forEach((item) => {
        item.classList.remove("active");
        const href = item.getAttribute("href");
        if (href === currentPath) {
          item.classList.add("active");
        }
      });

      const viewButtons = document.querySelectorAll(".view-btn");
      const gridView = document.getElementById("gridView");
      const listView = document.getElementById("listView");

      if (!gridView || !listView) return; // Guard against null elements

      viewButtons.forEach((button) => {
        button.addEventListener("click", function (this: HTMLButtonElement) {
          const view = this.dataset.view;

          // Update button states
          viewButtons.forEach((btn) => btn.classList.remove("active"));
          this.classList.add("active");

          // Toggle views with animation
          if (view === "grid") {
            listView.classList.add("fade-out");
            setTimeout(() => {
              listView.classList.add("hidden");
              gridView.classList.remove("hidden");
              gridView.classList.add("fade-in");
              listView.classList.remove("fade-out");
            }, 200);
          } else {
            gridView.classList.add("fade-out");
            setTimeout(() => {
              gridView.classList.add("hidden");
              listView.classList.remove("hidden");
              listView.classList.add("fade-in");
              gridView.classList.remove("fade-out");
            }, 200);
          }

          setTimeout(() => {
            gridView.classList.remove("fade-in");
            listView.classList.remove("fade-in");
          }, 400);
        });
      });

      // Project card click: redirect to bit치cora (incidencias) for the project
      const projectCards = document.querySelectorAll(
        ".project-card, .project-row"
      );
      projectCards.forEach((card) => {
        card.addEventListener("click", function (this: HTMLElement) {
          const projectId = this.dataset.projectId || "";
          // Redirect to the project detail page
          window.location.href = `/proyectos/${projectId}`;
        });
      });

      // Crear Proyecto button
      const btnCrearProyecto = document.getElementById("btnCrearProyecto");
      if (btnCrearProyecto) {
        btnCrearProyecto.addEventListener("click", () => {
          window.openModalProyecto("modalCrearProyecto");
        });
      }
    });
  </script>

  <ModalCrearProyecto />
</Layout>
