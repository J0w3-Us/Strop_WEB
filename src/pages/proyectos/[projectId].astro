---
import Layout from "../../layouts/Layout.astro";
import Topbar from "../../components/dashbord/Topbar.astro";
import Sidebar from "../../components/dashbord/Sidebar.astro";
import CommentsWidget from "../../components/incidents/CommentsWidget.astro";
import "../../styles/dashbord.css";
import { getIncidents } from "../../service/incident.service";

const { projectId } = Astro.params;

// Sample projects (mirror of the list used on the index page)
const proyectos = [
  {
    id: "1",
    name: "Residencial del Valle",
    clientName: "Inmobiliaria Sur",
    address: "Av. Siempre Viva 123",
    location: "Madrid",
    status: "active",
    progress: 0.75,
    openIncidents: 5,
    pendingApprovals: 2,
    teamCount: 8,
    icono: "building",
    color: "#0A58A3",
  },
  {
    id: "2",
    name: "Centro Comercial Norte",
    clientName: "Comercial SRL",
    address: "Calle Falsa 456",
    location: "Barcelona",
    status: "completed",
    progress: 1.0,
    openIncidents: 0,
    pendingApprovals: 0,
    teamCount: 5,
    icono: "office",
    color: "#10b981",
  },
  {
    id: "3",
    name: "Viaducto Metropolitano",
    clientName: "Infraestructuras SA",
    address: "Ruta Nacional km 12",
    location: "Valencia",
    status: "paused",
    progress: 0.2,
    openIncidents: 1,
    pendingApprovals: 0,
    teamCount: 12,
    icono: "bridge",
    color: "#f59e0b",
  },
];

// Use server-rendered dynamic routes instead of pre-rendering every project
export const prerender = false;

function statusLabel(status: string) {
  switch (status) {
    case "active":
      return "En Progreso";
    case "paused":
      return "Pausado";
    case "completed":
      return "Completado";
    case "cancelled":
      return "Cancelado";
    default:
      return status;
  }
}

function getProjectIcon(iconType: string): string {
  const icons: { [key: string]: string } = {
    building: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zM12 7c1.11 0 2 .89 2 2 0 .72-.38 1.39-1 1.73v1.77c0 .55-.45 1-1 1s-1-.45-1-1v-1.77c-.62-.34-1-1.01-1-1.73 0-1.11.89-2 2-2z"/></svg>`,
    office: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M19 4H5c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h14c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zM9 17H7v-2h2v2zm0-4H7v-2h2v2zm0-4H7V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>`,
    bridge: `<svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M7 16c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm6 0c0-.55.45-1 1-1s1 .45 1 1-.45 1-1 1-1-.45-1-1zm-3.5-8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S11.83 9 11 9s-1.5-.67-1.5-1.5zM22 21H2v-2h2V9.5C4 8.67 4.67 8 5.5 8h13c.83 0 1.5.67 1.5 1.5V19h2v2zM6 19h2v-7H6v7zm5 0h2v-7h-2v7zm5 0h2v-7h-2v7z"/></svg>`,
  };
  return icons[iconType] || icons.building;
  1;
}

const project = proyectos.find((p) => p.id === projectId);

// load incidents to display as cards in the left column (design-only)
const incidents = await getIncidents();
const projectIncidents = incidents.filter((i) => {
  const pid = String(i.projectId);
  return pid === String(projectId) || pid === `p-${projectId}`;
}); // filter by projectId con soporte a prefijo m√≥vil
const selected = projectIncidents[0] || null;
---

<Layout title={project ? `Proyecto - ${project.name}` : "Proyecto"}>
  <div class="dashboard-layout">
    <Sidebar />

    <div class="main-content">
      <Topbar />

      <div class="content-area">
        <div
          class="project-detail-body two-column-layout"
          data-incidents={JSON.stringify(projectIncidents)}
        >
          <aside class="left-col">
            <div class="cards-list">
              {
                projectIncidents.map((inc) => (
                  <article
                    class={`request-card ${inc.approvalStatus === "pending" ? "pending" : ""} ${inc.isCritical ? "urgent" : ""}`}
                    data-id={inc.id}
                  >
                    <div class="card-top">
                      <small
                        class={`card-badge flex items-center gap-1 ${
                          inc.type === "materialRequest"
                            ? "badge-material"
                            : inc.type === "safetyIncident"
                              ? "badge-safety"
                              : inc.type === "progressReport"
                                ? "badge-progress"
                                : inc.type === "problem"
                                  ? "badge-problem"
                                  : "badge-consultation"
                        }`}
                      >
                        {inc.type === "materialRequest" && (
                          <>
                            <svg
                              class="w-3 h-3"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2v14H3v3c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V2l-1.5 1.5z" />
                            </svg>{" "}
                            Solicitud de Material
                          </>
                        )}
                        {inc.type === "safetyIncident" && (
                          <>
                            <svg
                              class="w-3 h-3"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" />
                            </svg>{" "}
                            Seguridad
                          </>
                        )}
                        {inc.type === "progressReport" && (
                          <>
                            <svg
                              class="w-3 h-3"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                            </svg>{" "}
                            Avance
                          </>
                        )}
                        {inc.type === "problem" && (
                          <>
                            <svg
                              class="w-3 h-3"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                            </svg>{" "}
                            Problema
                          </>
                        )}
                        {inc.type === "consultation" && (
                          <>
                            <svg
                              class="w-3 h-3"
                              fill="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" />
                            </svg>{" "}
                            Consulta
                          </>
                        )}
                      </small>
                      {inc.isCritical ? (
                        <small class="urgent-label bg-status-rejected/10 text-status-rejected">
                          Solicitud Urgente
                        </small>
                      ) : null}
                    </div>

                    <h4 class="card-title">{inc.title}</h4>

                    {inc.type === "materialRequest" ? (
                      <div class="card-material">
                        Cantidad:{" "}
                        <strong>
                          {inc.materialDetails?.quantity}{" "}
                          {inc.materialDetails?.unit}
                        </strong>
                      </div>
                    ) : null}

                    <div class="card-meta">
                      <div class="author-mini">{inc.authorName}</div>
                      <div class="card-actions">
                        {inc.approvalStatus === "pending" ? (
                          <>
                            <button
                              class="btn-approve px-3 py-1 rounded text-xs font-medium bg-status-approved/10 text-status-approved hover:bg-status-approved/20 flex items-center gap-1"
                              data-id={`${inc.id}`}
                            >
                              <svg
                                class="w-3 h-3"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                              </svg>
                              Aprobar
                            </button>
                            <button
                              class="btn-reject px-3 py-1 rounded text-xs font-medium bg-status-rejected/10 text-status-rejected hover:bg-status-rejected/20 flex items-center gap-1"
                              data-id={`${inc.id}`}
                            >
                              <svg
                                class="w-3 h-3"
                                fill="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                              </svg>
                              Rechazar
                            </button>
                          </>
                        ) : (
                          <span
                            class={`approval-status px-2 py-1 rounded text-xs font-semibold ${
                              inc.approvalStatus === "approved"
                                ? "bg-status-approved/10 text-status-approved"
                                : inc.approvalStatus === "rejected"
                                  ? "bg-status-rejected/10 text-status-rejected"
                                  : "bg-status-pending/10 text-status-pending"
                            }`}
                          >
                            {inc.approvalStatus}
                          </span>
                        )}
                      </div>
                    </div>
                  </article>
                ))
              }
            </div>
          </aside>

          <section class="right-col">
            {
              selected ? (
                <div class="detail-panel" id="detailPanel">
                  <div class="detail-header">
                    <h2>{selected.title}</h2>
                    <div class="detail-sub">
                      {selected.type === "materialRequest"
                        ? "Solicitud de Material"
                        : selected.type}
                    </div>
                  </div>

                  <div class="detail-body">
                    <p class="detail-desc">{selected.description}</p>

                    <div class="detail-body-columns">
                      <div class="detail-right">
                        <h5>Comentarios</h5>
                        <CommentsWidget
                          incidentId={selected.id}
                          incidentTitle={selected.title}
                        />
                      </div>

                      <div class="detail-left">
                        <div class="photos">
                          <h5>Fotos Adjuntas</h5>
                          <div class="photos-grid">
                            <div class="photo">300√ó200</div>
                            <div class="photo">300√ó200</div>
                          </div>
                        </div>

                        <div class="location">
                          <h5>Ubicaci√≥n de Entrega</h5>
                          <div class="map-placeholder">300√ó300</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div class="not-found">
                  No hay solicitudes para este proyecto.
                </div>
              )
            }
          </section>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Client behavior: selection and approval (UI-only)
  const layoutEl = document.querySelector(".project-detail-body");
  let INCIDENTS: any[] = [];

  if (layoutEl) {
    const jsonAttr = layoutEl.getAttribute("data-incidents");
    console.log("üìù data-incidents attr found:", !!jsonAttr);
    if (jsonAttr) {
      try {
        INCIDENTS = JSON.parse(jsonAttr);
        console.log(
          "‚úÖ INCIDENTS loaded successfully:",
          INCIDENTS.length,
          "incidents"
        );
        console.log(
          "üìã Incident IDs:",
          INCIDENTS.map((i: any) => i.id)
        );
      } catch (e) {
        console.error("‚ùå Failed to parse INCIDENTS:", e);
        console.error("JSON attr:", jsonAttr.substring(0, 200));
        INCIDENTS = [];
      }
    }
  } else {
    console.warn("‚ö†Ô∏è project-detail-body element not found");
  }

  document.addEventListener("DOMContentLoaded", () => {
    console.log("üìã DOMContentLoaded fired");
    console.log("üìã INCIDENTS available:", INCIDENTS.length);

    const detailPanel = document.getElementById("detailPanel");

    // persistence via localStorage (solo para aprobaciones)
    const STORAGE_APPROVALS = "strop_incident_approvals";

    const storedApprovals = JSON.parse(
      localStorage.getItem(STORAGE_APPROVALS) || "{}"
    );

    function saveApprovals() {
      localStorage.setItem(STORAGE_APPROVALS, JSON.stringify(storedApprovals));
    }

    function findIncident(id: string) {
      console.log(`üîç Looking for incident with id: "${id}"`);
      const result = INCIDENTS.find((i: any) => String(i.id) === String(id));
      console.log(
        `${result ? "‚úÖ" : "‚ùå"} Result:`,
        result ? result.title : "NOT FOUND"
      );
      return result;
    }

    function updateCardApprovalUI(id: string, status: string) {
      // replace buttons with status badge or update existing badge
      const card = document.querySelector(
        `.request-card[data-id="${id}"]`
      ) as HTMLElement | null;
      if (!card) {
        console.warn(`‚ùå Card with id ${id} not found`);
        return;
      }
      const actions = card.querySelector(".card-actions") as HTMLElement | null;
      if (actions) {
        actions.innerHTML = `<span class="approval-status ${status}">${status}</span>`;
        console.log(`‚úÖ Updated card ${id} with status ${status}`);
      }
      // also set class for visual
      if (status === "approved") {
        card.classList.remove("pending");
      }
      if (status === "rejected") {
        card.classList.remove("pending");
      }
    }

    // Apply stored approvals to DOM
    INCIDENTS.forEach((inc: any) => {
      if (storedApprovals[inc.id]) {
        inc.approvalStatus = storedApprovals[inc.id];
        updateCardApprovalUI(inc.id, inc.approvalStatus);
      }
    });

    // Log all approve/reject buttons found
    const approveButtons = document.querySelectorAll(".btn-approve");
    const rejectButtons = document.querySelectorAll(".btn-reject");
    console.log(
      `üîò Found ${approveButtons.length} approve buttons and ${rejectButtons.length} reject buttons`
    );

    approveButtons.forEach((btn: any, idx) => {
      console.log(`  Button ${idx}: data-id="${btn.getAttribute("data-id")}"`);
    });

    // Click card -> select
    document.querySelectorAll(".request-card").forEach((c) => {
      const card = c as HTMLElement;
      card.addEventListener("click", (evt) => {
        // Prevent card selection if clicking on action buttons
        const target = evt.target as HTMLElement;
        if (target.closest(".btn-approve") || target.closest(".btn-reject")) {
          console.log("‚õî Clicked on button, preventing card selection");
          return;
        }

        const id = card.dataset.id as string;
        const inc = findIncident(id);
        if (!inc || !detailPanel) return;
        console.log("üìÑ Card selected:", id, inc.title);

        // update detail header and body
        const h2 = detailPanel.querySelector("h2");
        if (h2) h2.textContent = inc.title;
        const ds = detailPanel.querySelector(".detail-sub");
        if (ds)
          ds.textContent =
            inc.type === "materialRequest" ? "Solicitud de Material" : inc.type;
        const desc = detailPanel.querySelector(".detail-desc");
        if (desc) desc.textContent = inc.description;
        const infos = detailPanel.querySelectorAll(".detail-info .muted");
        if (infos && infos.length >= 3) {
          infos[0].textContent =
            document.querySelector(".page-title")?.textContent || "";
          infos[1].textContent = `${inc.authorName} (${inc.authorRole})`;
          infos[2].textContent = inc.materialDetails
            ? `${inc.materialDetails.quantity} ${inc.materialDetails.unit}`
            : "‚Äî";
        }
        // apply approval status in detail
        const actions = detailPanel.querySelector(".detail-actions");
        if (actions) {
          if (inc.approvalStatus === "pending") {
            actions.innerHTML = `<button class="btn-approve" data-id="${inc.id}">Aprobar</button><button class="btn-reject" data-id="${inc.id}">Rechazar</button>`;
          } else {
            actions.innerHTML = `<div class="approval-status ${inc.approvalStatus}">${inc.approvalStatus}</div>`;
          }
        }
      });
    });

    // Delegated approval handlers with detailed logging
    document.addEventListener(
      "click",
      (ev) => {
        const target = ev.target as HTMLElement | null;
        if (!target) return;

        const approveBtn = target.closest(".btn-approve") as HTMLElement | null;
        const rejectBtn = target.closest(".btn-reject") as HTMLElement | null;
        const btn = approveBtn || rejectBtn;

        if (!btn) return;

        console.log("üéØ Button clicked:", btn.className);
        ev.stopPropagation();

        const id = btn.getAttribute("data-id");
        console.log("üìå Button data-id:", `"${id}"`);

        if (!id) {
          console.error("‚ùå No data-id found on button");
          return;
        }

        const inc = findIncident(id);
        if (!inc) {
          console.error(`‚ùå No incident found with id: "${id}"`);
          console.log(
            "Available incidents:",
            INCIDENTS.map((i: any) => ({ id: i.id, title: i.title }))
          );
          return;
        }

        const newStatus = approveBtn ? "approved" : "rejected";
        console.log(`‚úÖ Processing ${id} as ${newStatus}`);

        inc.approvalStatus = newStatus;
        storedApprovals[id] = newStatus;
        saveApprovals();
        updateCardApprovalUI(id, newStatus);

        // update detail actions if the incident is currently selected
        if (detailPanel) {
          const hdr = detailPanel.querySelector(".detail-header h2");
          if (hdr && hdr.textContent === inc.title) {
            const actions = detailPanel.querySelector(".detail-actions");
            if (actions) {
              actions.innerHTML = `<div class="approval-status ${newStatus}">${newStatus}</div>`;
            }
          }
        }
      },
      true
    );
  });
</script>
