---
import Layout from "../../layouts/Layout.astro";
import Topbar from "../../components/Topbar/Topbar.astro";
import Sidebar from "../../components/Sidebar/Sidebar.astro";
import "../../styles/dashbord.css";
---

<Layout title="Puesto de Mando - Strop">
  <div class="dashboard-layout">
    <Sidebar />

    <div class="main-content">
      <Topbar />

      <div class="title-seccion">
        <h1>Puesto de Mando</h1>
      </div>
      <!-- Contenido del tablero: módulos principales -->
      <div class="content-area">
        <!-- 1) Overview KPI Row -->
        <section class="kpi-row">
          <div class="kpi-card kpi-critical">
            <div class="kpi-label">Incidencias Críticas</div>
            <div class="kpi-value" id="kpi-critical">0</div>
            <div class="kpi-note">priority == critical</div>
          </div>

          <div class="kpi-card kpi-approvals">
            <div class="kpi-label">Pendientes de Aprobación</div>
            <div class="kpi-value" id="kpi-pending">0</div>
            <div class="kpi-note">approvalStatus == pending</div>
          </div>

          <div class="kpi-card kpi-materials">
            <div class="kpi-label">Solicitudes de Material</div>
            <div class="kpi-value" id="kpi-materials">0</div>
            <div class="kpi-note">type == material</div>
          </div>

          <div class="kpi-card kpi-performance">
            <div class="kpi-label">Rendimiento (Abiertas / Cerradas)</div>
            <div class="kpi-value small" id="kpi-performance">0 / 0</div>
            <div class="kpi-note">Comparativa por proyecto</div>
          </div>
        </section>

        <!-- 2) Main Grid: Left (Incidents + Materials) | Right (Map, Users, Audit) -->
        <div class="dashboard-grid">
          <div class="left-colum">
            <!-- Incident Command: Kanban + Activity Feed -->
            <div class="widget">
              <div class="widget-header">
                <h2 class="widget-title">Centro de Comando de Incidencias</h2>
              </div>
              <div class="widget-content">
                <div class="kanban-row" id="kanban">
                  <div class="kanban-column" data-status="pendingApproval">
                    <h3>Pendiente Aprobación</h3>
                    <div class="kanban-list" id="col-pendingApproval"></div>
                  </div>
                  <div class="kanban-column" data-status="open">
                    <h3>Abierto</h3>
                    <div class="kanban-list" id="col-open"></div>
                  </div>
                  <div class="kanban-column" data-status="inProgress">
                    <h3>En Progreso</h3>
                    <div class="kanban-list" id="col-inProgress"></div>
                  </div>
                  <div class="kanban-column" data-status="closed">
                    <h3>Cerrado</h3>
                    <div class="kanban-list" id="col-closed"></div>
                  </div>
                  <div class="kanban-column" data-status="rejected">
                    <h3>Rechazado</h3>
                    <div class="kanban-list" id="col-rejected"></div>
                  </div>
                </div>

                <div class="activity-feed" id="activity-feed">
                  <h4>Actividad Reciente</h4>
                  <ul id="feed-list"></ul>
                </div>
              </div>
            </div>

            <!-- Materials / Inventory -->
            <div class="widget">
              <div class="widget-header">
                <h2 class="widget-title">Materiales e Inventario</h2>
              </div>
              <div class="widget-content">
                <div class="materials-controls">
                  <button id="btn-refresh-materials" class="btn"
                    >Refrescar</button
                  >
                </div>
                <div class="materials-table-wrapper">
                  <table class="materials-table" id="materials-table">
                    <thead>
                      <tr
                        ><th>Proyecto</th><th>Item</th><th>Cantidad</th><th
                          >Unidad</th
                        ><th>Acción</th></tr
                      >
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="right-colum">
            <!-- Map / GIS -->
            <div class="widget widget-map">
              <div class="widget-header">
                <h2 class="widget-title">Mapa de Obra</h2>
              </div>
              <div class="widget-content">
                <div id="map-placeholder">Mapa interactivo (placeholder)</div>
                <div class="map-legend" id="map-legend"></div>
              </div>
            </div>

            <!-- Users & Access -->
            <div class="widget">
              <div class="widget-header">
                <h2 class="widget-title">Gestión de Usuarios y Proyectos</h2>
              </div>
              <div class="widget-content">
                <div id="users-list"></div>
                <div class="users-actions">
                  <button class="btn" id="btn-new-user">Crear Usuario</button>
                </div>
              </div>
            </div>

            <!-- Audit & Export -->
            <div class="widget">
              <div class="widget-header">
                <h2 class="widget-title">Auditoría y Reportes</h2>
              </div>
              <div class="widget-content">
                <div class="audit-controls">
                  <button class="btn" id="btn-export-pdf">Exportar PDF</button>
                  <button class="btn" id="btn-export-xlsx"
                    >Exportar Excel</button
                  >
                </div>
                <div class="audit-log" id="audit-log">
                  <h4>Bitácora de Sincronización</h4>
                  <table class="audit-table">
                    <thead
                      ><tr
                        ><th>Incidencia</th><th>Creado (móvil)</th><th
                          >Recibido (servidor)</th
                        ></tr
                      ></thead
                    ><tbody id="audit-body"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Incident Detail Modal -->
        <div id="incident-modal" class="modal" aria-hidden="true">
          <div class="modal-content">
            <button class="modal-close" id="modal-close">✕</button>
            <h3 id="modal-title">Incidencia</h3>
            <div id="modal-body">
              <div class="modal-grid">
                <div class="modal-left">
                  <div id="evidence-gallery"></div>
                </div>
                <div class="modal-right">
                  <div class="meta-row">
                    <strong>ID:</strong>
                    <span id="meta-id"></span>
                  </div>
                  <div class="meta-row">
                    <strong>Proyecto:</strong>
                    <span id="meta-project"></span>
                  </div>
                  <div class="meta-row">
                    <strong>Prioridad:</strong>
                    <span id="meta-priority"></span>
                  </div>
                  <div class="meta-row">
                    <strong>Estado Aprobación:</strong>
                    <span id="meta-approval"></span>
                  </div>
                  <div class="meta-row">
                    <strong>Asignado a:</strong>
                    <select id="assign-to"></select>
                  </div>
                  <div class="meta-row">
                    <label for="close-note"
                      >Nota de cierre (obligatoria para cerrar)</label
                    >
                    <textarea id="close-note" rows="3"></textarea>
                  </div>
                  <div class="modal-actions">
                    <button id="btn-approve" class="btn btn-ok">Aprobar</button>
                    <button id="btn-reject" class="btn btn-danger"
                      >Rechazar</button
                    >
                    <button id="btn-close-incident" class="btn"
                      >Cerrar incidencia</button
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script type="module" src="/scripts/dashboard.js"></script>
      </div>
    </div>
  </div>
</Layout>
