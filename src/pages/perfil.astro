---
import DashboardLayout from "../layouts/DashboardLayout.astro";

// En producción, esto vendría de Astro.locals (inyectado por middleware)
// Por ahora usamos datos mock
const user = {
    id: "user-001",
    full_name: "Admin User",
    email: "admin@strop.mx",
    role: "owner_admin",
    created_at: "2024-01-15T10:00:00Z",
};

// Estado del formulario
let error = "";
let success = false;

// Procesar POST request
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const fullName = formData.get("full_name")?.toString().trim();

        if (!fullName) {
            error = "El nombre es requerido";
        } else {
            // Aquí iría dataService.updateProfile(user.id, { full_name: fullName })
            user.full_name = fullName;
            success = true;
        }
    } catch (e) {
        error = "Error al actualizar el perfil";
    }
}

// Helper functions
function getRoleDisplay(role: string): string {
    const roles: Record<string, string> = {
        owner_admin: "Administrador",
        superintendent: "Superintendente",
        resident: "Residente",
        cabo: "Cabo",
    };
    return roles[role] || role;
}

function formatDate(dateStr: string): string {
    return new Date(dateStr).toLocaleDateString("es-MX", {
        day: "numeric",
        month: "long",
        year: "numeric",
    });
}

function getUserInitials(name: string): string {
    const names = name.split(" ");
    if (names.length >= 2) {
        return `${names[0][0]}${names[1][0]}`.toUpperCase();
    }
    return names[0].substring(0, 2).toUpperCase();
}
---

<DashboardLayout title="Mi Perfil | STROP">
    <div class="profile-page">
        <div class="profile-container">
            <h1 class="page-title">Perfil de Usuario</h1>

            <!-- Header con Avatar -->
            <div class="profile-header">
                <div class="avatar-placeholder">
                    {getUserInitials(user.full_name)}
                </div>
                <div class="profile-info">
                    <h2 class="user-name">{user.full_name}</h2>
                    <span class="user-email">{user.email}</span>
                    <span class="role-badge">{getRoleDisplay(user.role)}</span>
                </div>
            </div>

            <!-- Mensajes de estado -->
            {
                error && (
                    <div class="message error">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <circle cx="12" cy="12" r="10" />
                            <line x1="15" y1="9" x2="9" y2="15" />
                            <line x1="9" y1="9" x2="15" y2="15" />
                        </svg>
                        {error}
                    </div>
                )
            }

            {
                success && (
                    <div class="message success">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            <polyline points="22 4 12 14.01 9 11.01" />
                        </svg>
                        Perfil actualizado correctamente
                    </div>
                )
            }

            <!-- Formulario de Información Personal -->
            <form method="POST" class="profile-form">
                <div class="form-section">
                    <h3 class="section-title">Información Personal</h3>

                    <div class="form-group">
                        <label for="full_name">Nombre Completo</label>
                        <input
                            type="text"
                            id="full_name"
                            name="full_name"
                            value={user.full_name}
                            class="input"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input
                            type="email"
                            id="email"
                            value={user.email}
                            class="input disabled"
                            disabled
                        />
                        <span class="field-hint"
                            >El email no puede ser modificado</span
                        >
                    </div>

                    <div class="form-group">
                        <label for="role">Rol</label>
                        <input
                            type="text"
                            id="role"
                            value={getRoleDisplay(user.role)}
                            class="input disabled"
                            disabled
                        />
                        <span class="field-hint"
                            >Contacta a un administrador para cambiar tu rol</span
                        >
                    </div>

                    <div class="form-group">
                        <label>Miembro desde</label>
                        <span class="static-value"
                            >{formatDate(user.created_at)}</span
                        >
                    </div>

                    <button type="submit" class="btn-primary">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="18"
                            height="18"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path
                                d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                            ></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Guardar Cambios
                    </button>
                </div>
            </form>

            <!-- Sección de Seguridad -->
            <div class="form-section security-section">
                <h3 class="section-title">Seguridad</h3>
                <p class="security-text">
                    Para cambiar tu contraseña, cierra sesión y utiliza la
                    opción "¿Olvidaste tu contraseña?" en la página de inicio de
                    sesión.
                </p>
                <a
                    href="/login"
                    class="btn-secondary"
                    onclick="document.cookie='sb-access-token=; path=/; max-age=0'; document.cookie='sb-refresh-token=; path=/; max-age=0';"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"
                        ></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    Cambiar Contraseña
                </a>
            </div>
        </div>
    </div>
</DashboardLayout>

<style>
    .profile-page {
        padding: 2rem;
        min-height: 100%;
        background: #f8fafc;
    }

    .profile-container {
        max-width: 600px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 1.5rem 0;
    }

    /* Header con Avatar */
    .profile-header {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        padding: 1.5rem;
        background: white;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        margin-bottom: 1.5rem;
    }

    .avatar-placeholder {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .user-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }

    .user-email {
        font-size: 0.875rem;
        color: #64748b;
    }

    .role-badge {
        display: inline-flex;
        align-self: flex-start;
        padding: 0.25rem 0.625rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        border-radius: 6px;
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    /* Mensajes */
    .message {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 1.5rem;
    }

    .message.error {
        background: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
    }

    .message.success {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    /* Formulario */
    .profile-form {
        margin-bottom: 1.5rem;
    }

    .form-section {
        background: white;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 1.25rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        display: block;
        font-size: 0.8rem;
        font-weight: 500;
        color: #64748b;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        font-family: inherit;
        color: #1e293b;
        background: white;
        transition: all 0.2s;
    }

    .input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input.disabled {
        background: #f8fafc;
        color: #94a3b8;
        cursor: not-allowed;
    }

    .field-hint {
        display: block;
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 0.375rem;
    }

    .static-value {
        display: block;
        font-size: 0.95rem;
        color: #1e293b;
        padding: 0.75rem 0;
    }

    .btn-primary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 0.5rem;
    }

    .btn-primary:hover {
        box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
        transform: translateY(-1px);
    }

    /* Seguridad */
    .security-section {
        margin-top: 1.5rem;
    }

    .security-text {
        font-size: 0.9rem;
        color: #64748b;
        line-height: 1.6;
        margin: 0 0 1.25rem 0;
    }

    .btn-secondary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        background: white;
        color: #475569;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #f8fafc;
        border-color: #2563eb;
        color: #2563eb;
    }

    /* Responsive */
    @media (max-width: 480px) {
        .profile-header {
            flex-direction: column;
            text-align: center;
        }

        .profile-info {
            align-items: center;
        }

        .role-badge {
            align-self: center;
        }
    }
</style>
